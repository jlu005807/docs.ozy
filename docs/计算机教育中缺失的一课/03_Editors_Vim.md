# Vim

> [!note]
>
> Vim 是一个 *多模态* 编辑 器：它对于插入文字和操纵文字有不同的模式。
>
> Vim 的接口本身也是一个程序语言：键入操作（以及其助记名） 是命令，这些命令也是可组合的。



## 编辑模式

- Vim的编辑模式

  > - **正常模式**：在文件中四处移动光标进行修改
  > - **插入模式**：插入文本
  > - **替换模式**：替换文本
  > - **可视化模式**（一般，行，块）：选中文本块
  > - **命令模式**：用于执行命令

- 在不同的操作模式下，键盘敲击的含义也不同。

  > [!tip]
  >
  > `x` 在插入模式会插入字母 `x`
  >
  > 在正常模式`x` 会删除当前光标所在的字母，
  >
  > `x`在可视模式下则会删除选中文块。

- 默认设置下，Vim **会在左下角显示当前的模式**。Vim 启动时的默认模式是正常模式。通常你会把大部分 时间花在正常模式和插入模式。

> [!important]
>
> 1. 按下 `<ESC>`（退出键）从任何其他模式返回正常模式。
> 2. 键入 `i` 进入插入 模式，
> 3. `R` 进入替换模式
> 4. `v` 进入可视（一般）模式
> 5. `V` 进入可视（行）模式
> 6. `<C-v>` （Ctrl-V, 有时也写作 `^V`）进入可视（块）模式，
> 7. `:` 进入命令模式。

---

## 基本操作

1. 插入文本

   > 在正常模式，键入 `i` 进入插入模式。现在 Vim 跟很多其他的编辑器一样，直到你键入 `<ESC>` 返回正常模式

2. 缓存， 标签页， 窗口

   > Vim 会维护一系列打开的文件，称为“缓存”。一个 Vim 会话包含一系列标签页，每个标签页包含 一系列窗口（分隔面板）。窗口只是缓冲区的视图。

3. 命令行

   > [!important]
   >
   > 在正常模式下键入 `:` 进入命令行模式。 在键入 `:` 后，你的光标会立即跳到屏幕下方的命令行。
   >
   > - `:q` 退出（关闭窗口）
   > - `:w` 保存（写）
   > - `:wq` 保存然后退出
   > - `:e {文件名}` 打开要编辑的文件
   > - `:ls` 显示打开的缓存
   > - :help {标题}打开帮助文档
   >   - `:help :w` 打开 `:w` 命令的帮助文档
   >   - `:help w` 打开 `w` 移动的帮助文档

---

## Vim编程

Vim 最重要的设计思想是 Vim 的界面本身是一个程序语言。键入操作（以及他们的助记名） 本身是命令，这些命令可以组合使用。

### 移动

多数时候你会在正常模式下，使用移动命令在缓存中导航。

> [!important]
>
> - 基本移动: `hjkl` （左， 下， 上， 右）
> - 词： `w` （下一个词）， `b` （词初）， `e` （词尾）
> - 行： `0` （行初）， `^` （第一个非空格字符）， `$` （行尾）
> - 屏幕： `H` （屏幕首行）， `M` （屏幕中间）， `L` （屏幕底部）
> - 翻页： `Ctrl-u` （上翻）， `Ctrl-d` （下翻）
> - 文件： `gg` （文件头）， `G` （文件尾）
> - 行数： `:{行数}<CR>` 或者 `{行数}G` ({行数}为行数)
> - 杂项： `%` （找到配对，比如括号或者 /* */ 之类的注释对）
> - 查找： `f{字符}`， `t{字符}`， `F{字符}`， `T{字符}`
>   - 查找/到 向前/向后 在本行的{字符}
>   - `,` / `;` 用于导航匹配
> - 搜索: `/{正则表达式}`, `n` / `N` 用于导航匹配

### 选择

可视化模式:

> - 可视化：`v`
> - 可视化行： `V`
> - 可视化块：`Ctrl+v`

可以用移动命令来选中

### 编辑

Vim 的编辑命令也被称为 “动词”， 因为动词可以施动于名词。

> [!note]
>
> - `i`进入插入模式
>   - 但是对于操纵/编辑文本，不单想用退格键完成
> - `O` / `o` 在之上/之下插入行
> - `d{移动命令}`删除 {移动命令}
>   - 例如，`dw` 删除词, `d$` 删除到行尾, `d0` 删除到行头。
> - `c{移动命令}`改变 {移动命令}
>   - 例如，`cw` 改变词
>   - 比如 `d{移动命令}` 再 `i`
> - `x` 删除字符（等同于 `dl`）
> - `s` 替换字符（等同于 `xi`）
> - 可视化模式 + 操作
>   - 选中文字, `d` 删除 或者 `c` 改变
> - `u` 撤销, `<C-r>` 重做
> - `y` 复制 / “yank” （其他一些命令比如 `d` 也会复制）
> - `p` 粘贴
> - 更多值得学习的: 比如 `~` 改变字符的大小写

---

### 计数

你可以用一个计数来结合“名词”和“动词”，这会执行指定操作若干次。

> - `3w` 向后移动三个词
> - `5j` 向下移动 5 行
> - `7dw` 删除 7 个词

### 修饰语

你可以用修饰语改变“名词”的意义。修饰语有 `i`，表示“内部”或者“在内”，和 `a`， 表示“周围”。

> - `ci(` 改变当前括号内的内容
> - `ci[` 改变当前方括号内的内容
> - `da'` 删除一个单引号字符串， 包括周围的单引号

---

## 演示

```python
这里是一个有问题的 fizz buzz 实现：

def fizz_buzz(limit):
    for i in range(limit):
        if i % 3 == 0:
            print('fizz')
        if i % 5 == 0:
            print('fizz')
        if i % 3 and i % 5:
            print(i)

def main():
    fizz_buzz(10)
```

> - 主函数没有被调用
>   - `G` 文件尾
>   - `o` 向下打开一个新行
>   - 输入 “if **name** …”
> - 从 0 而不是 1 开始
>   - 搜索 `/range`
>   - `ww` 向后移动两个词
>   - `i` 插入文字， “1, “
>   - `ea` 在 limit 后插入， “+1”
> - 在新的一行 “fizzbuzz”
>   - `jj$i` 插入文字到行尾
>   - 加入 “, end=’’”
>   - `jj.` 重复第二个打印
>   - `jjo` 在 if 打开一行
>   - 加入 “else: print()”
> - fizz fizz
>   - `ci'` 变到 fizz
> - 命令控制行参数
>   - `ggO` 向上打开
>   - “import sys”
>   - `/10`
>   - `ci(` to “int(sys.argv[1])”

---

## Vim进阶

### 搜索和替换

`:s` （替换）命令（[文档](http://vim.wikia.com/wiki/Search_and_replace)）。

- ```plaintext
  %s/foo/bar/g
  ```

  - 在整个文件中将 foo 全局替换成 bar

- ```plaintext
  %s/\[.*\](\(.*\))/\1/g
  ```

  - 将有命名的 Markdown 链接替换成简单 URLs

### 多窗口

- 用 `:sp` / `:vsp` 来分割窗口
- 同一个缓存可以在多个窗口中显示。

### 宏

- `q{字符}` 来开始在寄存器 `{字符}` 中录制宏
- `q` 停止录制
- `@{字符}` 重放宏
- 宏的执行遇错误会停止
- `{计数}@{字符}` 执行一个宏{计数}次
- 宏可以递归
  - 首先用 `q{字符}q` 清除宏
  - 录制该宏，用 `@{字符}` 来递归调用该宏 （在录制完成之前不会有任何操作）

> [!important]
>
> 例子：将 xml 转成 json ([file](https://missing-semester-cn.github.io/2020/files/example-data.xml))
>
> - 一个有 “name” / “email” 键对象的数组
> - 用一个 Python 程序？
> - 用 sed / 正则表达式
>   - `g/people/d`
>   - `%s/<person>/{/g`
>   - `%s/<name>\(.*\)<\/name>/"name": "\1",/g`
>   - …
> - Vim 命令 / 宏
>   - `ggdd`, `Gdd` 删除第一行和最后一行
>   - 格式化最后一个元素的宏 （寄存器 `e`）
>     - 跳转到有 `<name>` 的行
>     - `qe^r"f>s": "<ESC>f<C"<ESC>q`
>   - 格式化一个的宏
>     - 跳转到有 `<person>` 的行
>     - `qpS{<ESC>j@eA,<ESC>j@ejS},<ESC>q`
>   - 格式化一个标签然后转到另外一个 的宏
>     - 跳转到有 `<person>` 的行
>     - `qq@pjq`
>   - 执行宏到文件尾
>     - `999@q`
>   - 手动移除最后的 `,` 然后加上 `[` 和 `]` 分隔符

---

